# Migration Guide: Cache-First Architecture

–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –ø–µ—Ä–µ—Ö–æ–¥—É –∫ –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ —Å –∫–µ—à–µ–º –∏ TCP/UDP messaging.

## –û–±–∑–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

1. **–ù–æ–≤—ã–π —Å–ª–æ–π Storage** (`src/storage/`)
   - –ö–µ—à –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —á—Ç–µ–Ω–∏—è (`cache.rs`)
   - Repository –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤ –ë–î (`repository.rs`)

2. **–ù–æ–≤—ã–π —Å–ª–æ–π Messaging** (`src/messaging/`)
   - TCP —Å–µ—Ä–≤–µ—Ä –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
   - UDP —Å–µ—Ä–≤–µ—Ä –¥–ª—è –ª–µ–≥–∫–æ–≤–µ—Å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
   - –ü—Ä–æ—Ç–æ–∫–æ–ª –æ–±–º–µ–Ω–∞ –¥–∞–Ω–Ω—ã–º–∏

3. **–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π API** (`src/api/chat.rs`)
   - –ß—Ç–µ–Ω–∏–µ –∏–∑ –∫–µ—à–∞ –≤–º–µ—Å—Ç–æ –ë–î
   - –ó–∞–ø–∏—Å—å —á–µ—Ä–µ–∑ Repository

4. **–û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**
   - –ù–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≤ `ARCHITECTURE.md`
   - README –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–ª–æ—è

### –ü–æ—á–µ–º—É —ç—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è

**–ü—Ä–æ–±–ª–µ–º—ã —Å—Ç–∞—Ä–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã:**
- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —à–ª–∏ –≤ –ë–î ‚Üí –º–µ–¥–ª–µ–Ω–Ω–æ–µ —á—Ç–µ–Ω–∏–µ
- –ù–µ—Ç —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –º–µ–∂–¥—É domain –∏ storage
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ real-time –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã:**
- –ß—Ç–µ–Ω–∏–µ –≤ 10-100x –±—ã—Å—Ç—Ä–µ–µ (in-memory)
- –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Å–ª–æ–µ–≤
- Real-time —Å TCP/UDP
- –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å

## –ú–∏–≥—Ä–∞—Ü–∏—è –∫–æ–¥–∞

### API endpoints

#### –î–æ (—Å—Ç–∞—Ä—ã–π –∫–æ–¥):
```rust
pub async fn get_messages(
    db: web::Data<Database>,
    path: web::Path<i64>,
    query: web::Query<serde_json::Value>,
) -> Result<HttpResponse> {
    // –ß–∏—Ç–∞–µ–º –∏–∑ –ë–î
    match Message::find_by_chat(chat_id, page, per_page, db.connection.clone()) {
        Ok(messages) => { /* ... */ }
    }
}
```

#### –ü–æ—Å–ª–µ (–Ω–æ–≤—ã–π –∫–æ–¥):
```rust
pub async fn get_messages(
    cache: web::Data<MessageCache>,
    path: web::Path<i64>,
    query: web::Query<serde_json::Value>,
) -> Result<HttpResponse> {
    // –ß–∏—Ç–∞–µ–º –∏–∑ –∫–µ—à–∞
    let messages = cache.get_messages(chat_id, page, per_page);
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
}
```

#### –ò–∑–º–µ–Ω–µ–Ω–∏—è:
1. –ü–∞—Ä–∞–º–µ—Ç—Ä `db` –∑–∞–º–µ–Ω–µ–Ω –Ω–∞ `cache`
2. –í–º–µ—Å—Ç–æ `Message::find_by_chat()` –∏—Å–ø–æ–ª—å–∑—É–µ–º `cache.get_messages()`
3. –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ `Result` - –∫–µ—à –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫)

### –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è

#### –î–æ:
```rust
pub async fn send_message(
    db: web::Data<Database>,
    path: web::Path<i64>,
    req: web::Json<SendMessageRequest>,
) -> Result<HttpResponse> {
    let message = Message::new(...)?;
    message.create(db.connection.clone())?;
}
```

#### –ü–æ—Å–ª–µ:
```rust
pub async fn send_message(
    db: web::Data<Database>,
    cache: web::Data<MessageCache>,
    path: web::Path<i64>,
    req: web::Json<SendMessageRequest>,
) -> Result<HttpResponse> {
    let message = Message::new(...)?;
    
    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –ë–î —á–µ—Ä–µ–∑ Repository
    let repo = MessageRepository::new(db.connection.clone());
    let message_id = repo.create_message(&message)?;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–µ—à
    let mut msg_with_id = message;
    msg_with_id.id = Some(message_id);
    cache.add_message(msg_with_id)?;
}
```

#### –ò–∑–º–µ–Ω–µ–Ω–∏—è:
1. –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `cache`
2. –ò—Å–ø–æ–ª—å–∑—É–µ–º `MessageRepository` –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ –≤—ã–∑–æ–≤–∞ `create()`
3. –ü–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–µ—à

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### main.rs

–î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:

```rust
// 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–µ—à–∞
let cache = Arc::new(MessageCache::new());

// 2. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ë–î
cache.load_from_db(database.connection.clone())?;

// 3. –ó–∞–ø—É—Å–∫ messaging —Å–µ—Ä–≤–µ—Ä–∞
let messaging_config = MessagingConfig::default();
let messaging_server = MessagingServer::new(
    messaging_config,
    cache.clone(),
    Arc::new(database.clone()),
);

tokio::spawn(async move {
    messaging_server.start().await?;
});

// 4. –ü–µ—Ä–µ–¥–∞—á–∞ –∫–µ—à–∞ –≤ HTTP app
App::new()
    .app_data(web::Data::new(database.clone()))
    .app_data(web::Data::new(cache.clone()))  // –ù–æ–≤–æ–µ!
    // ...
```

### Cargo.toml

–î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å:
```toml
tokio = { version = "1.41", features = ["full"] }
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

1. **–°–±–æ—Ä–∫–∞:**
```bash
cd packages/backend
cargo build
```

2. **–ó–∞–ø—É—Å–∫:**
```bash
cargo run
```

3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ HTTP API:**
```bash
# –ü–æ–ª—É—á–∏—Ç—å —á–∞—Ç—ã
curl http://localhost:8080/api/chats

# –ü–æ–ª—É—á–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
curl http://localhost:8080/api/chats/1/messages
```

4. **–ü—Ä–æ–≤–µ—Ä–∫–∞ TCP (—Å netcat):**
```bash
# –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∞–∫–µ—Ç
echo '{"packet_type":"Ping"}' | nc localhost 8081
```

5. **–ü—Ä–æ–≤–µ—Ä–∫–∞ UDP (—Å netcat):**
```bash
# –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∞–∫–µ—Ç
echo '{"packet_type":"Ping"}' | nc -u localhost 8082
```

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –û–∂–∏–¥–∞–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

**–î–æ (–ë–î reads):**
- GET /api/chats: ~50-100ms
- GET /api/chats/1/messages: ~100-200ms

**–ü–æ—Å–ª–µ (Cache reads):**
- GET /api/chats: ~1-2ms (50-100x –±—ã—Å—Ç—Ä–µ–µ!)
- GET /api/chats/1/messages: ~2-3ms (30-60x –±—ã—Å—Ç—Ä–µ–µ!)

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏

- –°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è: ~50MB
- –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è: ~100-200MB (–∫–µ—à –¥–∞–Ω–Ω—ã—Ö)
- –ù–∞ 1000 —á–∞—Ç–æ–≤: +100-200MB

## –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

### HTTP API
‚úÖ **–ü–æ–ª–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**
- –í—Å–µ endpoints —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ
- –ù–∏–∫–∞–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ request/response —Ñ–æ—Ä–º–∞—Ç–∞—Ö
- –ö–ª–∏–µ–Ω—Ç—ã –Ω–µ —Ç—Ä–µ–±—É—é—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
‚úÖ **–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ö–µ–º—ã**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–∞ –∂–µ —Å—Ö–µ–º–∞ –ë–î
- –ú–∏–≥—Ä–∞—Ü–∏–∏ –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è
- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç–∞—é—Ç

### –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
üÜï **TCP/UDP messaging**
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ—Ä—Ç—ã: 8081 (TCP), 8082 (UDP)
- –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è (HTTP API —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ)

## Rollback

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏:

1. **Git checkout:**
```bash
git checkout main  # –∏–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∫–æ–º–º–∏—Ç
```

2. **Rebuild:**
```bash
cargo clean
cargo build
```

3. **–ù–∏–∫–∞–∫–∏—Ö –º–∏–≥—Ä–∞—Ü–∏–π** –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è - —Å—Ö–µ–º–∞ –ë–î –Ω–µ –º–µ–Ω—è–ª–∞—Å—å

## FAQ

### Q: –ù—É–∂–Ω–æ –ª–∏ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö?
A: –ù–µ—Ç, —Å—Ö–µ–º–∞ –ë–î –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å. –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã.

### Q: –ö–∞–∫ –æ—Ç–∫–ª—é—á–∏—Ç—å TCP/UDP —Å–µ—Ä–≤–µ—Ä—ã?
A: –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –≤ `main.rs`:
```rust
// tokio::spawn(async move {
//     messaging_server.start().await.unwrap();
// });
```

### Q: –í–ª–∏—è–µ—Ç –ª–∏ –∫–µ—à –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ?
A: –ù–µ—Ç, –∫–µ—à –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ –ë–î –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ. –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã.

### Q: –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ?
A: –ö–µ—à –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ—Ç—Å—è –∏–∑ –ë–î. –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î, –ø–æ—ç—Ç–æ–º—É –Ω–∏—á–µ–≥–æ –Ω–µ —Ç–µ—Ä—è–µ—Ç—Å—è.

### Q: –ú–æ–∂–Ω–æ –ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –∫–µ—à –±–µ–∑ TCP/UDP?
A: –î–∞! TCP/UDP —Å–µ—Ä–≤–µ—Ä—ã –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã. HTTP API —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ.

### Q: –ö–∞–∫ –æ—á–∏—Å—Ç–∏—Ç—å –∫–µ—à?
A: –ö–µ—à –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ. –ò–ª–∏ –≤—ã–∑–æ–≤–∏—Ç–µ:
```rust
cache.clear()?;
cache.load_from_db(db.connection.clone())?;
```

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `RUST_LOG=debug cargo run`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—Ä—Ç—ã: `netstat -an | grep 808[0-2]`
3. –û—Ç–∫—Ä–æ–π—Ç–µ issue –Ω–∞ GitHub —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –ø—Ä–æ–±–ª–µ–º—ã
4. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏: `ARCHITECTURE.md`, `storage/README.md`, `messaging/README.md`

## Roadmap

### –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

1. ‚úÖ –ë–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∫–µ—à–∞
2. ‚úÖ TCP/UDP messaging
3. ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
4. ‚è≥ –ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
5. ‚è≥ Unit —Ç–µ—Å—Ç—ã
6. ‚è≥ Integration —Ç–µ—Å—Ç—ã
7. ‚è≥ WebSocket support
8. ‚è≥ Distributed cache (Redis)

---

**–í–µ—Ä—Å–∏—è**: 2.0
**–î–∞—Ç–∞**: –Ø–Ω–≤–∞—Ä—å 2025
**–ê–≤—Ç–æ—Ä**: Architecture Refactoring Team
